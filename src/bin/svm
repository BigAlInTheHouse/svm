#!/bin/bash

#SVM_VERSION="{{VERSION}}"
SVM_VERSION="0.2.0"

SCRIPT_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"     # /.svm/bin
SVM_PATH=${SCRIPT_PATH%/bin}                                        # /.svm/
TEMP_PATH="$SVM_PATH/versions"                                      # /.svm/temp
VERSIONS_PATH="$SVM_PATH/versions"                                  # /.svm/versions
VERSION_FILE_PATH="$SVM_PATH/version"                               # /.svm/version

#
# helper functions
#

_svm_title_message() {
  local message="$1"
  echo -e "\n\e[1;4m $message \e[0m\n"
}
_svm_info_message() {
  local message="$1"
  echo -e " $message "
}
_svm_error_message() {
  local message="$1"
  echo -e "\e[41m $message \e[0m"
}

_svm_trim_string() {
  local string="$1"
  string="${string##*( )}" # trim leading whitespace
  string="${string%%*( )}" # trim trailing whitespace
  echo $string
}

_svm_get_active_version() {
  local active_version=""

  if [ ! -f "$VERSION_FILE_PATH" ];
  then
    echo -n "__NO_ACTIVE_VERSION__" > $VERSION_FILE_PATH
  else
    active_version=`cat $VERSION_FILE_PATH`
    active_version=$(_svm_trim_string "$active_version")
  fi

  echo $active_version
}

_svm_get_installed_versions() {
  local versions=()
  local active_version=""

  if [ -d "$VERSIONS_PATH" ]; then
    active_version=$(_svm_get_active_version)

    local installed_versions=(`ls "$VERSIONS_PATH"`)
    for installed_version in ${installed_versions[@]}; do
      [[ "$active_version" == "$installed_version" ]] && active="true" || active="false"
      versions+=("$active|$installed_version|$VERSIONS_PATH/$installed_version")
    done
  fi

  echo ${versions[@]}
}

#
# svm commands
#

_svm_help() {
  echo "  USAGE: svm <command> [options]"
  echo ""
  echo "  svm install <version>"
  echo "    Install scriptcs version indicated by <version>."
  echo "    examples:"
  echo "    > svm install 0.10.0"
  echo "    > svm install 0.10.1"
  echo ""
  echo "  svm install <version> -from <path>"
  echo "    Install scriptcs version from path <path> as version <version>. Path may be a local folder or a local NuGet package."
  echo "    examples:"
  echo "    > svm install mybuild-0.10.2 -from '/tmp/scriptcs/build'"
  echo "    > svm install 0.10.2 -from '/tmp/downloads/ScriptCs.0.10.2.nupkg'"
  echo ""
  echo "  svm install <-l|-list>"
  echo "    List the scriptcs versions avaiable to install."
  echo "    examples:"
  echo "    > svm install -l"
  echo ""
  echo "  svm remove <version>"
  echo "    Remove installed scriptcs version indicated by <version>."
  echo "    examples:"
  echo "    > svm remove 0.10.0"
  echo ""
  echo "  svm list [-a|-active]"
    echo "    List the installed scriptcs versions."
  echo "    -a|-active       list the active version"
  echo "    examples:"
  echo "    > svm list"
  echo "    > svm list -a"
  echo ""
  echo "  svm use <version>"
  echo "    Use the installed scriptcs version indicated by <version>."
  echo "    examples:"
  echo "    > svm use 0.10.2"
}

_svm_remove_version() {
  local version="$1"
  local installed_versions=()
  local is_version_installed=0
  local version_location=""

  version=$(_svm_trim_string "$version")
  installed_versions=($(_svm_get_installed_versions))
  for installed_version in "${installed_versions[@]}"; do
    if [ `echo $installed_version | cut -d'|' -f2` == "$version" ]; then
      is_version_installed=1
      version_location=`echo $installed_version | cut -d'|' -f3`
    fi
  done

  if [ $is_version_installed -eq "1" ]
  then
     if [[ $version_location == $VERSIONS_PATH* ]]; then rm -fr $version_location; fi # remove version with safety check that path starts with version folder
    _svm_info_message "The scriptcs version '$version' has been removed from versions folder '$VERSIONS_PATH'."

    installed_versions=($(_svm_get_installed_versions))
    if [ ${#installed_versions[@]} -gt 0 ]; then
      version=`echo ${installed_version[0]} | cut -d'|' -f2`
      echo "$version" > $VERSION_FILE_PATH
      _svm_info_message "The active scriptcs version has been set to '$version'."
    else
      echo "__NO_ACTIVE_VERSION__" > $VERSION_FILE_PATH
      _svm_info_message "No scriptcs versions left installed."
    fi
  else
    _svm_error_message "No scriptcs version $version available to remove."
  fi
}

_svm_list() {
  local installed_versions=()

  installed_versions=($(_svm_get_installed_versions))
  if [ ${#installed_versions[@]} -gt 0 ]; then
    local format_string="  %1s  %s\n"
    local active=""
    local version=""

    _svm_info_message "The following scriptcs versions are installed:\n"
    for installed_version in "${installed_versions[@]}"; do
      active=`echo $installed_version | cut -d'|' -f1`
      [[ "$active" == "true" ]] && active="*" || active=" "
      version=`echo $installed_version | cut -d'|' -f2`
      printf "$format_string" "$active" "$version"
    done
  else
    _svm_info_message "No scriptcs versions found."
    _svm_info_message "\n Consider using svm install <version> to install a scriptcs version."
  fi
}

_svm_list_active() {
  local installed_versions=()
  local active_version=""

  installed_versions=($(_svm_get_installed_versions))
  for installed_version in "${installed_versions[@]}"; do
    if [ `echo $installed_version | cut -d'|' -f1` == "true" ]; then
      active_version=`echo $installed_version | cut -d'|' -f2`
    fi
  done

  if [[ $active_version == "" && ${#installed_versions[@]} -gt 1 ]]; then
    _svm_info_message "No active scriptcs version found."
    _svm_info_message "\n Consider using svm use <version> to set the active scriptcs version."
  elif [[ $active_version == "" && ${#installed_versions[@]} -eq 0 ]]; then
    _svm_info_message "No scriptcs versions found."
    _svm_info_message "\n Consider using svm install <version> to install a scriptcs version."
  else
    _svm_info_message "The following is the active scriptcs version:\n"
    _svm_info_message "  $active_version"
  fi
}

_svm_use_version() {
  local version="$1"
  local is_version_installed=0

  version=$(_svm_trim_string "$version")
  local installed_versions=($(_svm_get_installed_versions))
  for installed_version in "${installed_versions[@]}"; do
    if [ `echo $installed_version | cut -d'|' -f2` == "$version" ]; then
      is_version_installed=1
    fi
  done

  if [ $is_version_installed -eq "1" ]
  then
    echo "$version" > $VERSION_FILE_PATH
    _svm_info_message "Active scriptcs version set to '$version'."
  else
    _svm_error_message "Version '$version' cannot be found in versions folder '$VERSIONS_PATH'."
    _svm_error_message "Consider using svm install <version> to install the scriptcs version."
  fi
}

#
# command switching
#

_svm_title_message "scriptcs version manager - $SVM_VERSION"

if [ $# -lt 1 ];
then

  _svm_help

else

  case $1 in

    "help" )
      # svm help
      _svm_help
    ;;

    "remove" )
      # svm remove <version>
      [[ $# -ne 2 ]] && _svm_help && echo "" && exit
      version="$2"
      _svm_remove_version "$version"
    ;;

    "list" )
      # svm list
      # svm list [-a|-active 
      if [ $# -eq 1 ]; then
        _svm_list
      elif [[ $# -eq 2 && ( $2 == "-a" || $2 == "-active" ) ]]; then
        _svm_list_active
      else
        _svm_help && echo "" && exit
      fi
    ;;

    "use" )
      # svm use <version>
      [[ $# -ne 2 ]] && _svm_help && echo "" && exit

      version="$2"
      _svm_use_version "$version"
    ;;

    *)
      _svm_help

  esac

fi

echo ""
